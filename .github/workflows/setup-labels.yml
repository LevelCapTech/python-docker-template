name: Setup Repository Labels

# このワークフローは、mainまたはmasterブランチへの最初のpushイベントでトリガーされます。
on: 
  push:
    branches:
      - main
      - master

permissions:
  issues: write
  pull-requests: none

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    steps:
      # ステップ1: リポジトリをチェックアウト
      - name: Check out the repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 全ての履歴をフェッチ

      # ステップ2: 親コミットのハッシュを取得
      - name: Get parent hash
        run: echo "PARENT_COUNT=$(git rev-parse HEAD^@ | wc -l)" >> $GITHUB_ENV

      # ステップ3: テンプレートからイシューを作成
      # 初回コミット（親コミットがない場合）のみイシューを作成
      - name: Create template issue
        if: env.PARENT_COUNT == 0
        uses: actions/github-script@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHubトークンの使用
        with:
          script: |
            // 既存のラベルを全て取得し削除します。
            const labels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            for (const label of labels.data) {
              await github.rest.issues.deleteLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label.name
              });
            }
            
            // 新しいラベルを作成します。
            await github.rest.issues.createLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'New Label',
              color: '008672',
              description: 'Label for new issues and PRs'
            });
          github-token: ${{ secrets.GITHUB_TOKEN }}
